<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test</title>
</head>
<body>
<table>
    <tr>
        <td>
            <label for="data">tx.data:</label>
        </td>
        <td>
            <input type="text" id="data"
                   value="050100000000000400000069C0485B020001000100000000A0724E1809000001000200000000A0724E18090000"/>
        </td>
    </tr>
    <tr>
        <td>
            <label for="hashin">tx.account_hashin:</label>
        </td>
        <td>
            <input type="text" id="hashin" value="AFB2FAACA5CB0C41A9F60AC84FA6D1A39C2D875F70FEEC3EEC70319962874FEC"/>
        </td>
    </tr>
</table>
<button id="btn-add-tx">add transaction</button>

<script type="text/javascript">
  class AdsWallet {
    constructor(extensionId) {
      this.extensionId = extensionId;
      this.port = null;
      this.initialized = false;
      this.queue = [];
    }

    static uuidv4() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    init() {
      return new Promise((resolve, reject) => {
        if (this.port) {
          return this.initialized ?
            resolve(this.port) :
            reject('ADS Wallet is not ready yet');
        }

        let channel = new MessageChannel();
        this.port = channel.port1;

        let onReady = (message) => {
          // when the iframe is ready to receive messages, it will send the string 'ready'
          if (message.data && message.data === 'ready') {
            this.port.removeEventListener('message', onReady);
            const base = this;
            this.port.onmessage = (event) => base.onMessage(event);
            // this.port.addEventListener('message', this.onMessage);
            this.initialized = true;
            resolve(this.port);
          } else {
            reject('Failed to initialize connection with ADS Wallet');
          }
        };
        this.port.addEventListener('message', onReady);
        this.port.start();

        // create the iframe
        const iframeOrigin = 'chrome-extension://' + this.extensionId;
        let iframe = document.createElement('iframe');
        iframe.src = iframeOrigin + '/proxy.html';
        iframe.setAttribute('style', 'display:none');
        document.body.appendChild(iframe);

        iframe.addEventListener('load', () => {
          // pass the port of message channel to the iframe
          iframe.contentWindow.postMessage('init', iframeOrigin, [channel.port2]);
        });
      })
    }

    onMessage(event) {
      console.debug('web: message', event.data);
      if (!event.data || !event.data.id) {
        throw new Error('Malformed message');
      }
      const item = this.queue.find(r => r.id === event.data.id);
      if (event.data.error) {
        if (!item || !item.reject) {
          throw new Error('Cannot reject message');
        }
        item.reject(event.data.error.message);
      } else if (!item || !item.resolve) {
        throw new Error('Cannot resolve message');
      }
      item.resolve(event.data.data);
    }

    sendMessage(type, data) {
      return new Promise((resolve, reject) => {
        this.init().then(() => {
          const id = AdsWallet.uuidv4();
          this.queue.push({ id, resolve, reject });
          this.port.postMessage({ id, type, data });
        }, reject);
      });
    }

    ping(data) {
      return this.sendMessage('ping', data);
    }

    getInfo() {
      return this.sendMessage('info');
    }

    signTransaction(data, msid, hash) {
      return this.sendMessage('sign', { data, msid, hash });
    }
  }

    let wallet = new AdsWallet('jfgepfclenckllcabhdflndcpedmoghb');

    wallet.ping(new Date().toISOString()).then((data) => {
        console.debug('pong:', data);
    }, (error) => {
        console.debug('failed:', error);
    });

    // Call addTransaction function
    let btnSend2 = document.getElementById('btn-add-tx');
    btnSend2.addEventListener('click', function () {
        console.log('index.html: click');
        const mid = (new Date().getTime()).toString(10);
        const txData = document.getElementById('data').value;
        const txAccountHashin = document.getElementById('hashin').value;
        wallet.signTransaction(txData, mid, txAccountHashin).then((data) => {
            console.debug('ok:', data);
        }, (error) => {
            console.debug('failed:', error);
        });
    }, false);

</script>
</body>
</html>
